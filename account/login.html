<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google - Lemon Software Bağlantısı</title>
  <script>
    const clientId = "288161427949-966r6ifanv6qvgsdrfega28rdbnrqbg4.apps.googleusercontent.com";
    const redirectUri = "https://lemonsoftware0.github.io/account/login.html";
    const state = "secure_random_state";  // Güvenli bir rastgele state parametresi

    // URL'deki parametreleri almak için yardımcı fonksiyon
    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        code: params.get("code"),
        state: params.get("state")
      };
    }

    // Google OAuth yetkilendirme sayfasına yönlendirme
    function redirectToGoogleAuth() {
      const authUrl = `https://accounts.google.com/o/oauth2/auth?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=profile email&state=${state}&access_type=online`;
      window.location.href = authUrl;
    }

    // Yetkilendirme kodunu kullanarak backend'den access token alma isteği gönder
    async function getAccessTokenFromServer(code) {
      const response = await fetch('http://localhost:5000/getAccessToken', {  // Flask sunucun burada çalışıyor
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ code })
      });
      return response.json();
    }

    // Access token ile backend'den kullanıcı bilgilerini al
    async function getUserInfoFromServer(accessToken) {
      const response = await fetch('http://localhost:5000/getUserInfo', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ accessToken })
      });
      return response.json();
    }

    // Kullanıcı bilgilerini yerel depolamaya kaydet
    function saveUserInfoToLocalStorage(userInfo) {
      localStorage.setItem("Google_Account_Name", userInfo.given_name);
      localStorage.setItem("Google_Account_Surname", userInfo.family_name);
      localStorage.setItem("Google_Account_Address", userInfo.email);
      localStorage.setItem("Google_Account_Photo", userInfo.picture);
    }

    // Sayfa yüklendiğinde yapılacak işlemler
    async function handlePageLoad() {
      const params = getQueryParams();

      if (!params.code) {
        // Eğer URL'de yetkilendirme kodu yoksa, Google OAuth sayfasına yönlendirme yap
        redirectToGoogleAuth();
      } else {
        try {
          // Backend'e kodu gönder ve access token al
          const tokenResponse = await getAccessTokenFromServer(params.code);
          const accessToken = tokenResponse.access_token;

          if (accessToken) {
            // Backend'den kullanıcı bilgilerini al ve yerel depolamaya kaydet
            const userInfo = await getUserInfoFromServer(accessToken);
            saveUserInfoToLocalStorage(userInfo);

            // Kullanıcı bilgileri kaydedildikten sonra yönlendirme yap
            window.location.href = "https://lemonsoftware0.github.io/?command=afterlogin&with=Google";
          } else {
            console.error("Access token alınamadı.");
          }
        } catch (error) {
          console.error("Bir hata oluştu:", error);
        }
      }
    }

    // Sayfa yüklendiğinde işlemleri başlat
    window.onload = handlePageLoad;
  </script>
</head>
<body>
  <p>Devam ediyor... (Bu sayfada sıkışırsan geliştirici konsolunu kontrol et)</p>
</body>
</html>
